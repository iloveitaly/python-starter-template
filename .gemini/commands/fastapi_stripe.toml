description = "Fastapi_Stripe"
prompt = "A Stripe Checkout implementation takes four steps:\n\n1. Create a checkout session. Happens when the user visits the checkout page.\n2. Create a pending order. Happens right before the user is sent to Stripe.\n3. Complete the order. Happens when the user is redirected back to the app after payment.\n4. Check the order status. Happens when the user visits the confirmation page, which could happen multiple times.\n\nHere's an example implementation:\n\n```python\nfrom .configuration import stripe_client, origin_url\n\n@screening_api_app.post(\"/\")\ndef create_order_session(\n    request: Request,\n) -> str:\n    \"\"\"\n    Creates a checkout session. This happens after the user visits\n    the checkout page.\n    \"\"\"\n    session = stripe_client.v1.checkout.sessions.create(\n        params={\n            \"ui_mode\": \"custom\",\n            \"line_items\": [\n                {\n                    \"price\": \"price_123\",\n                    \"quantity\": 1,\n                }\n            ],\n            \"mode\": \"payment\",\n            # CHECKOUT_SESSION_ID is a placeholder for the actual session id, which is replaced by Stripe\n            # cannot use include_query_params because the Stripe checkout template variable is escaped\n            \"return_url\": (\n                # `request` required for abs URL generation\n                str(request.url_for(\"complete_ticket_purchase\"))\n                + \"?session_id={CHECKOUT_SESSION_ID}\"\n            ),\n        }\n    )\n\n    return session.client_secret\n\n\nclass PendingOrderRequest(BaseModel):\n    stripe_checkout_session_id: str\n\n    email: str\n    # and other fields...\n\n\n@screening_api_app.post(\"/pending\")\ndef create_pending_order(\n    data: PendingOrderRequest,\n    distribution: Distribution = Depends(get_distribution_by_host),\n) -> TypeIDType:\n    \"\"\"\n    Right before we pass off the user to Stripe, we save all order information.\n\n    This can happen multiple times if there is a form submission error with Stripe.\n\n    This pending step is in place largely because many payment methods require a redirect to a confirmation page,\n    so we assume we'll always be redirected.\n\n    The database schema ensures duplicate stripe checkout session ids never happen.\n    \"\"\"\n\n\n    # let's validate the stripe checkout session id is real\n    stripe_session = stripe_client.v1.checkout.sessions.retrieve(\n        data.stripe_checkout_session_id\n    )\n\n    if stripe_session.status != \"open\":\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Your checkout session has expired. Please refresh the page and try again.\",\n        )\n\n    order = Order.one_or_none(\n        stripe_checkout_session_id=data.stripe_checkout_session_id\n    )\n\n    if order:\n        order.email = data.email\n        # ...and other fields...\n        order.save()\n    else:\n        order = Order(\n            stripe_checkout_session_id=data.stripe_checkout_session_id,\n            email=data.email,\n        ).save()\n\n    return order.id\n\n\n@screening_api_app.get(\"/complete\")\ndef complete_ticket_purchase(\n    request: Request,\n    session_id: str = Query(),\n):\n    stripe_session = stripe_client.v1.checkout.sessions.retrieve(session_id)\n\n    if stripe_session.status != \"complete\":\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND)\n\n    order = Order.one(stripe_checkout_session_id=session_id)\n\n    order.status = OrderState.paid\n    order.save()\n\n    redirect_url = f\"{origin_url}/screening/{order.screening_id}/confirmation/{session_id}\"\n    return RedirectResponse(url=redirect_url)\n\n\n@screening_api_app.get(\"/confirmation\")\ndef ticket_purchase_status(\n    request: Request,\n    stripe_checkout_session_id: str = Query(),\n    screening_id: TypeIDType = Query(),\n) -> str:\n    stripe_client = distribution.stripe_client()\n    stripe_session = stripe_client.v1.checkout.sessions.retrieve(\n        stripe_checkout_session_id\n    )\n\n    if stripe_session.status != \"complete\":\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Checkout is not complete\",\n        )\n\n    order = Order.one(stripe_checkout_session_id=stripe_checkout_session_id)\n    return order.id\n\n\npublic_api_app.include_router(screening_api_app)\n```\n"
