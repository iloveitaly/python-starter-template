name: "Common Setup"
description: "Internal action for common setup across jobs"
# NOTE timeout-minutes *cannot* bet set within a action and must be set at the root level
runs:
  using: "composite"
  steps:
    # NOTE cannot run checkout in this local action, must be run by the parent action
    # mise can rarely get stuck installing. It normally takes < 10s to install, so this should never be more than a minute
    # web/ has it's own mise config, but it's copied from the root mise config, so we don't need to worry about it
    - uses: jdx/mise-action@v3
      env:
        MISE_ENV: dev
      with:
        version: 2026.2.8
    # TODO document: https://github.com/actions/runner-images/issues/4849, https://github.com/actions/runner-images/issues/264
    - uses: tecolicom/actions-use-apt-tools@v1
      with:
        # TODO is there *really* not a backend for zsh in mise?
        tools: zsh libnss3-tools
    # host config needs to be generated first, before direnv, then localias can be setup
    - shell: bash
      run: just dev_generate_hosts
    # without any additional options, this simply installs the latest version of the cli
    - uses: 1password/load-secrets-action@v2
    - uses: iloveitaly/github-action-direnv-load-and-mask@master
      with:
        environment_allowlist: >
          PYTHON_SERVER_HOST, PYTHON_TEST_SERVER_HOST, JAVASCRIPT_SERVER_HOST, VITE_PYTHON_URL, PYTHONPYCACHEPREFIX, ALLOWED_HOST_LIST, PLAYWRIGHT_BROWSERS_PATH, TEST_RESULTS_DIRECTORY

    - shell: bash
      run: just dev_generate_localias
    # cache node_modules
    - uses: actions/cache@v5
      with:
        path: web/node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('web/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-node-modules
